<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Тяжёлое бремя времени</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="src/styles/yandex2/styles/screen-16x9.css">
    <link rel="stylesheet" href="src/highlight/styles/github.css">
    <style>
        .shower {
            --slide-ratio: calc(16 / 9);
        }

        .slide ul > li:lang(ru)::before {
            content: '';
        }

        .slide ol > li strong,
        .slide ul > li strong {
            display: inline;
        }

        .slide li table th,
        .slide li table td {
            text-indent: 0 !important;
        }

        .slide .columns-2 ol {
            float: left;
            margin-left: 70px;
            list-style: none;
            padding: 0;
            line-height: 60px;
            width: 780px;
        }

        .slide .shout {
            font-size: 2em;
        }

        .slide h3 a {
            text-decoration: none;
            color: black;
            background: none;
        }

        .slide.big-image > div {
            bottom: 0;
            overflow: hidden;
        }

        .slide.big-image img,
        .slide.big-image video {
            max-width: 100%;
            max-height: 100%;
        }

        pre.margin-30 {
            margin: 30px 0;
        }
    </style>
</head>
<body class="shower list">

<header class="caption">
    <h1>
        Тяжёлое бремя времени:<br>
        типичные ошибки при работе со временем
    </h1>
    <p>
        Виктор Хомяков, <a href="https://yandex.ru/">Яндекс</a>
    </p>
</header>

<section class="slide title">
    <div>
        <h2>
            Тяжёлое бремя времени:<br>
            <span style="font-size: 70px; line-height: 70px;">типичные ошибки при работе со временем</span>
        </h2>
        <h3><img src="src/styles/yandex2/images/title-logo-ru.svg" alt="Logo" /></h3>
        <div class="authors">
            <p>Виктор Хомяков, Яндекс</p>
        </div>
    </div>
</section>

<!-- вступление -->
<!-- почему именно я рассказываю именно об этой теме и какой у меня опыт в данной области -->
<section class="slide">
    <div style="left: 690px">
        <h2>О себе</h2>
        <p>
            Я работал в трёх продуктовых компаниях,
            видел много кода в проектах на разных языках и фреймворках
            (Java, C#, JavaScript).
        </p>
    </div>
    <img class="place left height cover" src="pictures/me.jpg" alt="Виктор Хомяков">
</section>

<!-- почему аудитории важно послушать мой доклад -->
<section class="slide">
    <div>
        <h2>Что я увидел</h2>
        <ol>
            <li class="next">
                В разных проектах возникают похожие задачи по работе с датой/временем
            </li>
            <li class="next">
                Также возникают похожие задачи вызова асинхронных/удалённых частей кода (AJAX, запросы в БД и т.п.)
            </li>
            <li class="next">
                Разные люди решают эти задачи почти одинаково, независимо от языка
            </li>
            <li class="next">
                И допускают одинаковые ошибки
            </li>
        </ol>
    </div>
</section>

<!-- какую пользу получит слушатель от моего выступления -->
<section class="slide">
    <div>
        <h2>О чём я хочу рассказать</h2>
        <ul>
            <li class="next">
                О повторяющихся паттернах при работе с датой/временем/асинхронным кодом
            </li>
            <li class="next">
                Об ошибках, которые легко сделать
            </li>
            <li class="next">
                И как их не допускать
            </li>
        </ul>
    </div>
</section>

<!-- основная часть -->

<section class="slide">
    <div>
        <h2 class="shout shrink">
            Часть первая.<br>
            Время назад
        </h2>
    </div>
</section>

<!-- 1.1 -->
<section class="slide">
    <div>
        <h2 class="shout shrink">1.1. Время не стоит на месте</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Пример: взаимозависимые cookies</h2>
        <pre>
<code class="hljs javascript">const expires1 = Date.now() + 100500;
setCookie1(expires1);
const expires2 = Date.now() + 100500;
setCookie2(expires2);</code>
        </pre>
        <p class="next">
            <code>Date.now()</code> &mdash; не константа!
        </p>
        <p class="place right bottom">
            <img src="pictures/trollface.png" alt="" class="place right bottom">
            Проблемы, тимлид?
        </p>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Сценарии</h2>
        <ul>
            <li>
                Сайт с глобальной аудиторией (github)&hellip;<br>
                <span class="next">каждый 24-й посетитель &mdash; там, где полночь</span>
            </li>
            <li class="next">
                Локальный сайт&hellip;<br>
                <span class="next">с промо-акцией в полночь</span>
            </li>
            <!-- спросить, кто читает Хабр -->
            <li class="next">
                Страничка для своего кота&hellip;<br>
                <span class="next">хабраэффект</span>
            </li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Мораль</h2>
        <ul>
            <li>
                В одном методе должен быть только один <code>Date.now()</code>
            </li>
            <li class="next">
                Связанные по смыслу переменные должны вычисляться из одной даты
            </li>
        </ul>
    </div>
</section>

<!-- 1.2 -->
<section class="slide">
    <div>
        <h2 class="shout shrink">1.2. Измерение интервалов и логирование событий</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Логируем транзакции</h2>
        <pre>
<code class="hljs javascript">const start = Date.now(); // 1550000000000
transaction();
const finish = Date.now(); // 1549999999000
log(`Транзакция длилась ${finish - start}мс`); // Транзакция длилась -1000мс</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2>JavaScript</h2>
        <p>
            <code>Date.now()</code> &mdash; неравномерный и немонотонный
        </p>
        <p class="next">
            NTP daemon может
            <a href="https://serverfault.com/questions/94683/will-ntp-drift-the-clock-backwards">
                замедлять и отматывать назад
            </a>
            часы
        </p>
        <p class="next">
            Пользователь может сам менять время
        </p>
        <p class="next">
            Надо использовать <code>performance.now()</code>
        </p>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Бэкэнд</h2>
        <p>
            Аналогичная проблема, гуглить "consistent monotonic clock"
        </p>
        <p class="next">
            Для Java:
            <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/System.html#nanoTime()">
                System.nanoTime()
            </a>
        </p>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Распределённая система</h2>
        <img src="pictures/clock-7.jpg" style="width: 31%" alt="Clock 7" class="next">
        <img src="pictures/clock-2.jpg" style="width: 31%" alt="Clock 2" class="next">
        <img src="pictures/clock-9.jpg" style="width: 31%" alt="Clock 9" class="next">
        <p class="next">
            Вектор времени или счётчики событий
        </p>
    </div>
</section>

<section class="slide">
    <div>
        <h2 class="shout shrink">
            Часть вторая.<br>
            Такая асинхронная асинхронность
        </h2>
    </div>
</section>

<!-- 2.1 -->
<section class="slide">
    <div>
        <h2 class="shout shrink">2.1 AJAX и коллбэки</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Пример: два запроса</h2>
        <pre>
<code class="hljs javascript">ajax(query1, callback);
ajax(query2, callback);</code>
        </pre>
        <p class="next">
            Последовательность коллбэков не гарантирована!
        </p>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Варианты выполнения</h2>
        <pre>
<code class="next">query1 &rarr; callback(response1) &rarr; query2 &rarr; callback(response2)</code>

<code class="next">query1 &rarr; query2 &rarr; callback(response1) &rarr; callback(response2)</code>

<code class="next">query1 &rarr; query2 &rarr; callback(response2) &rarr; callback(response1)</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <p>
            TODO видео саджеста
        </p>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Часто встречается на UI</h2>
        <ul>
            <li class="next">
                вывод подсказок autocomplete, suggest
            </li>
            <li class="next">
                переключение вкладок в tabbed UI
            </li>
            <li class="next">
                drag&drop однотипных элементов (товары в корзину)
            </li>
            <li class="next">
                drag&drop одного и того же элемента (карточка на канбан-доске)
            </li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Мораль</h2>
        <p>
            Если есть источник однотипных запросов:
        </p>
        <ul>
            <li class="next">
                при поступлении следующего запроса прерываем все незавершённые
            </li>
            <li class="next">
                при обработке ответов игнорируем старые
            </li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>В RxJS это уже решено</h2>
        <pre>
<code class="hljs javascript">var keyups = Rx.Observable.fromEvent($('#input'), 'keyup')
    .pluck('target', 'value')
    .filter(text => text.length > 2)
    .debounce(500 /* миллисекунд */)
    .distinctUntilChanged();

var suggestions = keyups.flatMapLatest(ajax); // игнорируем старые ответы</code>
        </pre>
    </div>
</section>

<!-- 2.2 -->
<section class="slide">
    <div>
        <h2 class="shout shrink">2.2 Есть ли жизнь после destroy?</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Что можно улучшить в этом коде?</h2>
        <pre>
<code class="hljs javascript">const scrollHandler = function() {/*код*/};
window.addEventListener('scroll', scrollHandler);</code>
        </pre>
    </div>
    <img src="pictures/thinking-face.png" alt="" class="place left bottom" style="height: 35%; left: 5%;">
</section>

<section class="slide">
    <div>
        <p>
            События, которые возникают слишком часто:
        </p>
        <ul>
            <li class="next">resize</li>
            <li class="next">scroll</li>
            <li class="next">mousemove</li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <figure>
            <img src="pictures/throttling-01.png" alt="throttle" style="width: 100%;">
        </figure>
    </div>
</section>

<section class="slide">
    <div>
        <p>
            События, которые возникают слишком часто:
        </p>
        <ul>
            <li class="next">keyup</li>
            <li class="next">tap</li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <figure>
            <img src="pictures/debounce.png" alt="debounce" style="width: 100%;">
        </figure>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Для scroll нужен throttle</h2>
        <pre>
<code class="hljs javascript">const scrollHandler = _.throttle(function() {/*код*/}, 200 /*миллисекунд*/);
window.addEventListener('scroll', scrollHandler);</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Не забываем про destroy объекта</h2>
        <pre>
<code class="hljs javascript">class InfiniteScroll {
    constructor() {
        this._scrollHandler = _.throttle(this.scrollHandler.bind(this),
            200 /*миллисекунд*/);
        window.addEventListener('scroll', this._scrollHandler);
    }

    scrollHandler() {/* код */}

    destroy() {
        this._scrollHandler.cancel(); // убираем за собой
    }
}</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <p>
            После деструктора методы объекта всё ещё могут вызваться:
        </p>
        <ul>
            <li class="next">
                из <code>_.throttle()</code>, <code>_.debounce()</code>
            </li>
            <li class="next">
                из <code>setTimeout()</code>, <code>setInterval()</code>
            </li>
            <li class="next">
                из <code>requestAnimationFrame()</code>, <code>requestIdleCallback</code>
            </li>
            <li class="next">
                из незавершённых запросов AJAX/fetch
            </li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Мораль</h2>
        <p>
            Причина проблем &mdash; несовпадение времени жизни объектов
        </p>
        <ul>
            <li class="next">
                вызов кода мёртвого объекта
            </li>
            <li class="next">
                утечки памяти
            </li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2 class="shout shrink">
            Часть третья.<br>
            Нежданная синхронность
        </h2>
    </div>
</section>

<!-- 3.1 -->
<section class="slide">
    <div>
        <h2 class="shout shrink">3.1 Promise</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Что в этом коде можно ускорить?</h2>
        <pre>
<code class="hljs javascript">query1()
    .then(() => query2())
    .then(() => {
        // обработка ответов
    });</code>
        </pre>
        <p class="next">
            Иногда код запросов можно распараллелить
        </p>
    </div>
    <img src="pictures/thinking-face.png" alt="" class="place left bottom" style="height: 35%; left: 5%;">
</section>

<section class="slide">
    <div>
        <h2>Управляем асинхронным кодом</h2>
        <p>
            Promise
        </p>
        <ul>
            <li class="next">
                <code>Promise.all()</code>
            </li>
            <li class="next">
                <code>Promise.race()</code>
            </li>
            <li class="next">
                чего-то не хватает
            </li>
        </ul>
        <p class="next">
            <a href="https://caolan.github.io/async/">Async</a>:
            библиотека для удобного планирования задач
        </p>
        <ul>
            <li class="next">
                <code>async.parallel()</code>
            </li>
            <li class="next">
                <code>async.series()</code>
            </li>
            <li class="next">
                <code>async.waterfall()</code>
            </li>
        </ul>
    </div>
</section>

<!-- 3.2 -->
<section class="slide">
    <div>
        <h2 class="shout shrink">3.2 Await</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Используя await, главное &mdash; не перестараться</h2>
        <pre>
<code class="hljs javascript">const data1 = await query1();
const data2 = await query2();</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Используя await, главное &mdash; не перестараться</h2>
        <pre>
<code class="hljs javascript">const data1 = await query1(); // ждём выполнения первого запроса
const data2 = await query2(); // ждём выполнения второго запроса</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Если запросы &mdash; независимые</h2>
        <pre>
<code class="hljs javascript">const [data1, data2] = await Promise.all(
    [query1(), query2()]
);</code>
        </pre>
        <ul>
            <li class="next">
                выполняются параллельно
            </li>
            <li class="next">
                при ошибках быстрее упадём
            </li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <p>
            Проще написать <code>await</code>, чем <code>.then().then()</code>
        </p>
        <p class="next">
            Проще внести незапланированную синхронизацию
        </p>
        <p class="next">
            Следите за кодом &mdash; возможно, ваши <code>await</code>можно распараллелить!
        </p>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Материалы</h2>
        <ul>
            <li>
                <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all">
                    Описание Promise.all на MDN
                </a>
            </li>
            <li class="next">
                <a href="https://caolan.github.io/async/">
                    Async
                </a>
            </li>
            <li class="next">
                <a href="https://github.com/Reactive-Extensions/RxJS">
                    RxJS 4
                </a>,
                <a href="https://github.com/ReactiveX/rxjs">
                    RxJS 5+
                </a>
            </li>
            <li class="next">
                Про debouncing и throttling
                <a href="https://css-tricks.com/debouncing-throttling-explained-examples/">
                    на английском
                </a>
                и
                <a href="https://artemdemo.me/blog/throttling-vs-debouncing/">
                    на русском языке
                </a>
            </li>
            <li class="next">
                <a href="https://www.softwariness.com/articles/monotonic-clocks-windows-and-posix/">
                    Monotonic Clocks in Windows and POSIX
                </a>
            </li>
            <li class="next">
                <a href="http://doc.ntp.org/4.1.0/ntpd.htm">
                    How ntpd operates
                </a>
            </li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2 class="shout shrink">Заключение</h2>
    </div>
</section>

<section class="slide">
    <div>
        <ul>
            <li>
                Предупреждён &mdash; значит, вооружён. Разрабатывая аналогичную функциональность, сразу избегайте
                ошибок.
            </li>
            <li class="next">
                Изучение open-source библиотек (Lodash, RxJS и т.п.) расширяет сознание.
                Возможно, прямо сейчас вы изобретаете велосипед.
                Нельзя красиво решить проблему, если не знаешь о самом существовании такого класса проблем.
            </li>
        </ul>
    </div>
</section>

<section class="slide contacts">
    <div>
        <h2>Спасибо! Вопросы?</h2>
        <figure>
            <h3>Виктор Хомяков</h3>
            <p>разработчик интерфейсов</p>
        </figure>

        <hr />
        <ul>
            <li class="mail">vkhomyackov@gmail.com</li>
            <li class="mail">v-homyakov@yandex-team.ru</li>
        </ul>
        <ul>
            <li class="github">victor-homyakov</li>
        </ul>
    </div>
</section>

<div class="progress"></div>

<script src="shower/shower.min.js"></script>
<script src="src/highlight/highlight.pack.js"></script>
<script>
    console.timeStamp('Начало inline JS');

    console.time('add keywords');
    (function() {
        var js = hljs.getLanguage('javascript');
        if (js && js.k && (typeof js.k.built_in === 'string')) {
            js.k.built_in += ' performance process';
        }
    })();
    console.timeEnd('add keywords');

    console.time('init hljs');
    hljs.initHighlightingOnLoad();
    console.timeEnd('init hljs');
</script>
</body>
</html>
